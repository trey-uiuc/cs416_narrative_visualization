<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Worldly Wines</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>

      body {
        font-family: Arial;
        font-size: 8pt;
      }

      h1 {
        font-size: 24pt;
      }

      h2, .subheader {
        font-size: 12pt;
      }

      svg {
        border: 2px solid black;
      }

      #scene1 {
        background-color: #bde0ff;
      }

      path {
        stroke: red;
        stroke-width: 0.25px;
      }

      .country {
        fill: white;
      }

      #tooltip1 {
        position: absolute;
        visibility: hidden;
        z-index: 100;
        width: auto;
        height: auto;
        text-align: center;
        padding: 10px;
        margin: 5px;
        background: lightsteelblue;
        border: 1px;
        border-radius: 5px;
      }

    </style>

  </head>
  <body>
    <h1>Wines Reviewed Around the World</h1>
    <p class="subheader">The following graphic utilizes a heatmap to illustrate the number of wines that were reviewed in each country around the world.</p>
    <ul style="font-size: 10pt;">
      <li>Click on any country to see more details about wines that grow in the region!</li>
      <li>The data for this project was borrowed from a publicly available dataset on <a href="https://www.kaggle.com/datasets/zynicide/wine-reviews">Kaggle</a>.</li>
    </ul>
    <div id="tooltip1"><p>I'm a tooltip!</p></div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <script>

      function get_data() {
        let result = d3.csv("./data/wine.csv")
          .then(function(data){
              data.forEach(d => {
                      if (d.country == "US") {
                              d.country = "United States of America";
                      } else if (d.country == "England") {
                              d.country = "United Kingdon";
                      }
              })
              return data;
          });
        return result;
      }

      var width = 1000,
         height = 500;

      var margin = {top: 10, right: 10, bottom: 125, left: 50}

      let light_red = d3.rgb(242, 218, 218);
      let dark_red = d3.rgb(115, 9, 9);

      var projection = d3.geoMercator()
          .scale(150);

      var svg = d3.select("body").append("svg")
          .attr("width", width)
          .attr("height", height)
          .attr("id", "scene1")

      var path = d3.geoPath()
          .projection(projection);

      var g = svg.append("g");

      // load and display the World
      d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json")
              .then(function(topology) {
                  let data = get_data()
                        .then(function(wine_data) {
                          let grouped_map = d3.rollup(wine_data, v => v.length, d => d.country);
                          let grouped_arr = Array.from(grouped_map, ([key, value]) => ({key, value}));
                          let filtered_data = grouped_arr.filter((d) => d.value > 10);
                          let filtered_map = new Map(
                            filtered_data.map(object => {
                              return [object.key, object.value];
                            }),
                          );

                          var mouseover = function(d) {
                                  let row_data = d.target.__data__.properties;
                                  let wine_row = filtered_map.get(row_data.name);
                                  let wines_reviewed = 0;
                                  if (wine_row > 0) wines_reviewed = wine_row;

                                  d3.select("#tooltip1")
                                    .style("top", d.pageY+"px")
                                    .style("left", d.pageX+"px")
                                    .html("<p><b>" + row_data.name + "<br>" + wines_reviewed.toLocaleString('en-US') + "</b> wines reviewed" + "</p>")
                                    .style("visibility", "visible")
                                }

                          var mousemove = function(d) {
                                  d3.select("#tooltip1")
                                    .style("top", d.pageY+"px")
                                    .style("left", d.pageX+"px");
                                }

                          var mouseleave = function(d) {
                                  d3.select("#tooltip1")
                                    .style("visibility", "hidden");
                                }

                          var clicker = function(d) {
                                  d3.select("#scene2").remove();
                                  d3.select("#scene2_title").remove();
                                  mouseleave();

                                  let country = d.target.__data__.properties.name;
                                  let width2 = width - margin.left - margin.right;
                                  let height2 = height - margin.top - margin.bottom;

                                  var header = d3.select("body").append("h2")
                                    .attr("class", "subheader")
                                    .attr("id", "scene2_title")
                                    .text(`Most Popular Wines in ${country}`);

                                  var svg2 = d3.select("body").append("svg")
                                      .attr("width", width)
                                      .attr("height", height)
                                      .attr("id", "scene2")

                                  var g2 = svg2.append("g")
                                    .attr("transform", `translate(${margin.left}, ${margin.top})`);

                                  let filtered_data = wine_data.filter((d) => d.country == country);
                                  let grouped_map = d3.rollup(filtered_data, v=> v.length, d => d.variety);
                                  let grouped_arr = Array.from(grouped_map, ([key, value]) => ({key, value}));
                                  let sorted_arr = grouped_arr.sort((a, b) => d3.descending(a.value, b.value))
                                  console.log("sorted_arr");
                                  console.log(sorted_arr);
                                  let sliced_arr = sorted_arr.slice(0,20);

                                  var x = d3.scaleBand()
                                    .domain(sliced_arr.map(d => d.key))
                                    .range([0, width2])
                                    .padding(0.15);

                                  var y = d3.scaleLinear()
                                    .domain([0, d3.max(sliced_arr, d => d.value)])
                                    .range([height2, 0]);

                                  var color2 = d3.scaleSequential()
                                    .domain([0, d3.max(sliced_arr, d => d.value)])
                                    .interpolator(d3.interpolateReds);

                                  let xAxis = d3.axisBottom(x);
                                  let yAxis = d3.axisLeft(y);

                                  g2.append("g").selectAll("rect")
                                    .data(sliced_arr)
                                    .join("rect")
                                      .attr("x", d => x(d.key))
                                      .attr("width", x.bandwidth())
                                      .attr("y", d => y(d.value))
                                      .attr("height", d => height2 - y(d.value))
                                      .attr("fill", d => color2(d.value));

                                  g2.append("g")
                                    .attr("transform", `translate(0, ${height2})`)
                                    .call(xAxis)
                                    .selectAll("text")
                                    .style("text-anchor", "end")
                                    .attr("dx", "-.8em")
                                    .attr("dy", ".15em")
                                    .attr("transform", "rotate(-65)");

                                  g2.append("g")
                                    .call(yAxis);
                          }

                          const color = d3.scaleLinear()
                                  .domain([d3.min(filtered_map.values()), d3.max(filtered_map.values())])
                                  .range([d3.rgb(242, 218, 218), d3.rgb(115, 9, 9)]);

                          g.append("rect")
                                .attr("class", "key")
                                .attr("x", 20)
                                .attr("y", 465)
                                .attr("height", 8)
                                .attr("width", 8)
                                .attr("fill", light_red);

                          g.append("text")
                                .attr("class", "key")
                                .attr("x", 35)
                                .attr("y", 472.5)
                                .attr("text-anchor", "start")
                                .text("0-10,000 wines reviewed")

                          g.append("rect")
                                .attr("class", "key")
                                .attr("x", 20)
                                .attr("y", 480)
                                .attr("height", 8)
                                .attr("width", 8)
                                .attr("fill", dark_red);

                          g.append("text")
                                .attr("class", "key")
                                .attr("x", 35)
                                .attr("y", 487.5)
                                .attr("text-anchor", "start")
                                .text("10,000+ wines reviewed")

                          g.selectAll("path")
                             .data(topojson.feature(topology, topology.objects.countries).features)
                             .enter().append("path")
                             .attr("class", "country")
                             .attr("text", d => d.properties.name)
                             .style("fill", d => {
                                     const wine_row = filtered_map.get(d.properties.name);
                                     if (wine_row > 0) return color(wine_row);
                                   })
                             .attr("d", path)
                             .on("mouseover", mouseover)
                             .on("mousemove", mousemove)
                             .on("mouseleave", mouseleave)
                             .on("click", clicker);
                        });
                  });

    </script>

  </body>
</html>
